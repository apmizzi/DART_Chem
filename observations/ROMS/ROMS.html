<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
          "http://www.w3.org/TR/html4/strict.dtd">
<HTML>
<HEAD>
<TITLE>ROMS verification observations to DART observation sequences</TITLE>
<link rel="stylesheet" type="text/css" href="../../doc/html/doc.css" />
<link href="../../doc/images/dart.ico" rel="shortcut icon" />
</HEAD>
<BODY>
<A NAME="TOP"></A>

<H1>ROMS observations to DART observation sequences</H1>

<table border=0 summary="" cellpadding=5>
<tr>
    <td valign=middle>
    <img src="../../doc/images/Dartboard7.png" alt="DART project logo" height=70 />
    </td>
    <td>
       <P>Jump to <a href="../../index.html">DART Documentation Main Index</a><br />
          <small><small>version information for this file: <br />
          <!-- version tag follows, do not edit -->
          $Id$</small></small>
       </P></td>
</tr>
</table>

<A HREF="#DataSources">DATA SOURCES</A> /
<A HREF="#Programs">PROGRAMS</A> / 
<A HREF="#Namelist">NAMELIST</A> /
<A HREF="#Modules">MODULES</A> /
<A HREF="#Errors">ERRORS</A> /
<A HREF="#FuturePlans">FUTURE PLANS</A> /
<A HREF="#Legalese">TERMS OF USE</A>

<H2>Overview</H2>

<P>
The relationship between ROMS and DART is slightly different
than most other models.  ROMS has the ability to apply its own forward operator 
as the model is advancing (a capability needed for variational assimilation) 
which produces something the ROMS community calls '<em class=italic>verification</em>' 
observations.  The observation file that is input to ROMS is specified by the 
<em class=file>s4dvar.in</em>:<em class=code>OBSname</em> variable.
The verification obs are written out to a netcdf file whose name is specified by the
<em class=file>s4dvar.in</em>:<em class=code>MODname</em> variable.
Since each ROMS model is advancing independently, a set of verification observation
files are created during a DART/ROMS assimilation cycle. This set of files
can be converted using <em class=program>convert_roms_obs</em> to produce a 
DART observation sequence file that has precomputed forward operators (FOs).  
<em class=program>convert_roms_obs</em> can also convert 
<em class=file>s4dvar.in</em>:<em class=code>OBSname</em>,<em class=code>MODname</em> 
files to a DART observation sequence file that does not have the precomputed FOs.
</P>

<P>
The ROMS verification observation files <strong>must</strong> contain
the following variables:
</P>
<ul>
   <li>either <em class=green>obs_Xgrid, obs_Ygrid, obs_depth</em> -or-
              <em class=green>obs_lat, obs_long, obs_depth</em></li>
   <li><em class=green>obs_value</em></li>
   <li><em class=green>obs_error</em></li>
   <li><em class=green>obs_type</em></li>
   <li><em class=green>obs_time</em></li>
   <li><em class=green>NLmodel_value</em></li>
   <li><em class=green>obs_scale</em></li>
   <li><em class=green>obs_provenance</em> which must have <br />
       <em class=green>obs_provenance:flag_values</em>, and <br />
       <em class=green>obs_provenance:flag_meanings</em> attributes.</li>
</ul>

<P>
The conversion of a (set of) ROMS verification observations requires metadata to
coordinate the relationship of the ROMS observation provenance to a DART observation TYPE.
ROMS provides significant flexibility when specifying the observation provenance and it
is simply impractical for DART to try to support all of them. 
An example of the current practice is described in the <a href="#Programs">PROGRAMS</a>
section below.
</P>

<!--==================== DESCRIPTION OF A NAMELIST =====================-->

<A NAME="Namelist"></A>
<div class="top">[<a href="#">top</a>]</div><hr />
<H2>NAMELIST</H2>
<P>
This namelist is read from the file <em class=file>input.nml</em>.
Namelists start with an ampersand
'&amp;' and terminate with a slash '/'.
Character strings that contain a '/' must be
enclosed in quotes to prevent them from
prematurely terminating the namelist.
</P>

<div class=namelist>
<pre>
&amp;convert_roms_obs_nml
   ens_size               = 1
   roms_input_obs_file    = 'roms_obs.nc'
   roms_mod_obs_files     = ''
   roms_mod_obs_filelist  = 'filelist.txt'
   dart_output_obs_file   = 'obs_seq.out'
   append_to_existing     = .false.
   use_precomputed_values = .true.
   locations_in_IJK       = .false.
   add_random_noise       = .false.
   pert_amplitude         = 0.01
   verbose                = 0
   type_translations      = 'NULL'
  /
</pre>
</div>

<br />
<br />

<div>
<TABLE border=0 cellpadding=10 width=100% summary='namelist description'>
<THEAD align=left>
<TR><TH> Item </TH>
    <TH> Type </TH>
    <TH> Description </TH> </TR>
</THEAD>

<TBODY valign=top>

<TR><TD> ens_size </TD>
    <TD> integer </TD>
    <TD> Number of ensemble members which are expected to
be found when creating the expected obs values.  This must
match the number of ROMS "mod" files listed in either the
'roms_mod_obs_files' or 'roms_mod_obs_filelist' namelist
items.  It is an error if they are not the same length.
</TD></TR>

<TR><TD> roms_input_obs_file </TD>
    <TD> character(len=256) </TD>
    <TD> The file with the original obs definitions.
         Contrast with the "mod" files.
</TD></TR>

<TR><TD> roms_mods_obs_files </TD>
    <TD> character(len=256), dimension(100) </TD>
    <TD> List of filenames, one per ensemble member, that contain the
observation values for each ensemble member.  These are output from
the ROMS program.  If listing the files explicitly in this list,
'roms_mod_obs_filelist' must be '&nbsp;' (null).
</TD></TR>

<TR><TD> roms_mods_obs_filelist </TD>
    <TD> character(len=256) </TD>
    <TD> The name of an ASCII file which contains, one per line,
a list of filenames, one per ensemble member, that contain the
expected obs values for each ensemble member.  The
filenames should NOT be quoted. These are output from
the ROMS program.  If using a filelist, then
'roms_mod_obs_files' must be '&nbsp;' (null).
</TD></TR>

<TR><TD> dart_output_obs_file </TD>
    <TD> character(len=256) </TD>
    <TD> The name of the DART obs_seq file to create.  If a file
already exists with this name, it is either appended to or overwritten
depending on the 'append_to_existing' setting below.
</TD></TR>

<TR><TD> append_to_existing </TD>
    <TD> logical </TD>
    <TD> If an existing 'dart_output_obs_file' is found,
this namelist item controls how it is handled.  If .true.
the new observations are appended to the existing file.
If .false. the new observations overwrite the existing file.
</TD></TR>

<TR><TD> use_precomputed_values </TD>
    <TD> logical </TD>
    <TD> flag to indicate that the output DART observation 
         sequence file should include the verification observation 
         values from all of the ROMS observation files. 
         If <em class=mono>.true.</em> this will result in the 
         DART file having the precomputed FOs to be used in the 
         DART assimilation. 
         If <em class=mono>.false.</em> this will result in 
         DART files having the instrument values only.
</TD></TR>

<TR><TD> locations_in_IJK </TD>
    <TD> logical </TD>
    <TD> Observation location information can exist in the
'roms_input_obs_file' as either fractional grid indices I,J,K
or as 'obs_lat', 'obs_lon'.  If this flag is .true., the
I,J,K indices will be read.
</TD></TR>

<TR><TD> add_random_noise </TD>
    <TD> logical </TD>
    <TD> Almost always should be .false. . The exception is
the first cycle of an assimilation if all the ROMS input
files are identical (no ensemble currently exists).  
To create differences in the forward
operator values (since they are computed by ROMS), we can
add gaussian noise here to give them perturbed values.
This should be set as well as the 
"perturb_from_single_instance = .true."
namelist in the &amp;filter_nml namelist.
After the first cycle, both these should be set back
to .false. .
</TD></TR>

<TR><TD> pert_amplitude </TD>
    <TD> real(r8) </TD>
    <TD> Ignored unless 'add_random_noise' is .true. .
Controls the range of random values added to the
expected obs values.  Sets the width of a gaussian.
</TD></TR>

<TR><TD> verbose </TD>
    <TD> integer </TD>
    <TD> If greater than 0, prints more information during
the conversion.  
</TD></TR>

<TR><TD> type_translations </TD>
    <TD> character(256), dimension(2, 100) </TD>
    <TD> A set of strings which control the mapping of ROMS
observation types to DART observation types.  These should
be specified in pairs.  The first column should be a string
that occurs in the 'roms_input_obs_file' in the attribute
'flag_meanings' on the 'obs_provenance' variable.
Note that this information also occurs as a global variable
in the same file; this information is currently ignored.
The second column should be a DART specific obs type that
is found in <em class=file>DART/obs_kind/obs_kind_mod.f90</em>, 
which is created by the DART <em class=program>preprocess</em> program.
</TD></TR>

</TBODY>
</TABLE>
</div>

<br />
<br />


<!--==================================================================-->

<A NAME="DataSources"></A>
<HR />
<H2>DATA SOURCES</H2>

<P>
The origin of the input observation files used by ROMS are completely unknown to me.
</P>

<!--==================================================================-->

<A NAME="Programs"></A>
<HR />
<H2>PROGRAMS</H2>

<ul><li><a href="../convert_roms_obs.html">convert_roms_obs</a>
    <li><a href="../../obs_sequence/obs_seq_to_netcdf.html">obs_seq_to_netcdf</a>
    <li><a href="../../obs_sequence/obs_sequence_tool.html">obs_sequence_tool</a>
    <li><a href="../../preprocess/preprocess.html">preprocess</a>
    <li><a href="../../time_manager/advance_time.html">advance_time</a>
</ul>

<P>
Only <em class=program>convert_roms_obs</em> will be discussed here. 

The ROMS input netCDF file(s) must have an <em class=mono>obs_provenance</em> 
variable with at least the following attributes:
</P>

<pre>
	int obs_provenance(datum) ;
		obs_provenance:flag_values = 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11 ;
		obs_provenance:flag_meanings = "gridded_AVISO_SLA blended_SST XBT_Met_Office CTD_temperature_Met_Office CTD_salinity_Met_Office ARGO_temperature_Met_Office ARGO_salinity_Met_Office CTD_temperature_CalCOFI CTD_salinity_CalCOFI CTD_temperature_GLOBEC CTD_salinity_GLOBEC" ;
</pre>

<P>The <em class=mono>flag_meanings</em> attribute is used to relate observation provenance to DART observation TYPES by <strong>exactly</strong> specifying the character strings as in the following example:
</P>

<pre>
# the roms_input_obs_file should be the same as the first item in the precomputed_files.txt
&amp;convert_roms_obs_nml
   ens_size               = 3
   roms_input_obs_file    = '../data/wc13_obs.nc'
   roms_mod_obs_filelist  = 'precomputed_files.txt'
   dart_output_obs_file   = 'obs_seq.out'
   append_to_existing     = .false.
   use_precomputed_values = .true.
   locations_in_IJK       = .false.
   add_random_noise       = .false.
   pert_amplitude         = 0.01
   verbose                = 1
   type_translations = "gridded_AVISO_SLA",            "SATELLITE_SSH",
                       "blended_SST",                  "SATELLITE_MICROWAVE_SST",
                       "XBT_Met_Office",               "XBT_TEMPERATURE",
                       "CTD_temperature_Met_Office",   "CTD_TEMPERATURE",
                       "CTD_salinity_Met_Office",      "CTD_SALINITY",
                       "ARGO_temperature_Met_Office",  "ARGO_TEMPERATURE",
                       "ARGO_salinity_Met_Office",     "ARGO_SALINITY",
                       "CTD_temperature_CalCOFI",      "CTD_TEMPERATURE",
                       "CTD_salinity_CalCOFI",         "CTD_SALINITY",
                       "CTD_temperature_GLOBEC",       "CTD_TEMPERATURE",
                       "CTD_salinity_GLOBEC",          "CTD_SALINITY",
 /
</pre>

<P>A complete list of DART observation TYPES is available in <a href="../../obs_def/obs_def_ocean_mod.f90">obs_def_ocean_mod.f90</a>
</P>

<!-- P>
There are currently converters for these data types:</P>
<TABLE border=0 cellpadding=3 summary="">
<TBODY valign=top>
<TR> <TD> ACARS aircraft T,U,V,Q data </TD>  <TD> convert_madis_acars    </TD>
<TR> <TD> Marine surface data         </TD>  <TD> convert_madis_marine   </TD>
<TR> <TD> Mesonet surface data        </TD>  <TD> convert_madis_mesonet  </TD>
<TR> <TD> Metar data                  </TD>  <TD> convert_madis_metar    </TD>
<TR> <TD> Wind Profiler data          </TD>  <TD> convert_madis_profiler </TD>
<TR> <TD> Rawinsonde/Radiosonde data  </TD>  <TD> convert_madis_rawin    </TD>
<TR> <TD> Satellite Wind data         </TD>  <TD> convert_madis_satwnd   </TD>
</TABLE>
<P>
Example data files are in the <em class=file>data</em> directory.
Example scripts for converting batches of these files are
in the <em class=file>shell_scripts</em> directory.  
These are <em>NOT</em> intended to be turnkey scripts; they will
certainly need to be customized for your use.  There are comments
at the top of the scripts saying what options they include, and
should be commented enough to indicate where changes will be
likely to need to be made.
</P>
<P>Several converters have compile-time choices
for outputting various types of moist variables.
Check the source code for more details.
Some converters also read multiple T/F strings
from the console (standard input) to control at
run-time what types of observations to convert.
Again, check the source code for more details.
</P>
<P>Each converter has hard-coded input and output filenames:</P>
<TABLE border=0 cellpadding=5 summary="input/output filenames">
<TBODY valign=top>
<TR> <TD>convert_madis_acars:   </TD> <TD> acars_input.nc    </TD> <TD> obs_seq.acars    </TD>
<TR> <TD>convert_madis_marine:  </TD> <TD> marine_input.nc   </TD> <TD> obs_seq.marine   </TD>
<TR> <TD>convert_madis_mesonet: </TD> <TD> mesonet_input.nc  </TD> <TD> obs_seq.mesonet  </TD>
<TR> <TD>convert_madis_metar:   </TD> <TD> metar_input.nc    </TD> <TD> obs_seq.metar    </TD>
<TR> <TD>convert_madis_profiler:</TD> <TD> profiler_input.nc </TD> <TD> obs_seq.profiler </TD>
<TR> <TD>convert_madis_rawin:   </TD> <TD> rawin_input.nc    </TD> <TD> obs_seq.rawin    </TD>
<TR> <TD>convert_madis_satwnd:  </TD> <TD> satwnd_input.nc   </TD> <TD> obs_seq.satwnd   </TD>
</TABLE>

<P>The expected usage pattern is that a script will copy,
rename, or make a symbolic link from the actual input file
(which often contains a timestamp in the name) to the fixed input 
name before conversion, and move the output file to an
appropriate filename before the next invocation of the converter.  
If an existing observation sequence file of the same output name is 
found when the converter is run again, it will open that file and append
the next set of observations to it.
</P -->

<!--==================================================================-->
<!-- Describe the bugs.                                               -->
<!--==================================================================-->

<A NAME="KnownBugs"></A>
<HR />
<H2>KNOWN BUGS</H2>
<P>
none
</P>

<!--==================================================================-->
<!-- Describe Future Plans.                                           -->
<!--==================================================================-->

<A NAME="FuturePlans"></A>
<HR />
<H2>FUTURE PLANS</H2>
<P>
<OL><li>either remove the need for <em class=green>ens_size</em> or use
        it to check the consistency of the number of files to convert. </li>
    <li>remove the <em class=green>roms_obs_files()</em> mechanism.</li>
    <li>remove the <em class=green>roms_obs_file</em> mechanism -or- IF
        the <em class=green>ens_size</em> is specified, just
        use the first file and ignore the <em class=green>roms_obs_file</em>.</li>
    <li>extend the <em class=green>type_translations</em> table to be able to
        support a superset of obs_provenance-to-DART_TYPE relationships.</li>
    <li>could remove the <em class=green>locations_in_IJK</em> variable by simply
        checking if the <em class=green>obs_lon, obs_lat</em> variables exist.
        If <em class=green>obs_lon, obs_lat</em> exist, they should be used;
        if not, try the IJK method.
        </li>
</OL>

<!--==================================================================-->
<!-- Legalese & Metadata                                              -->
<!--==================================================================-->

<A NAME="Legalese"></A>
<HR />
<H2>Terms of Use</H2>

<P>
DART software - Copyright 2004 - 2013 UCAR.<br />
This open source software is provided by UCAR, "as is",<br />
without charge, subject to all terms of use at<br />
<a href="http://www.image.ucar.edu/DAReS/DART/DART_download">
http://www.image.ucar.edu/DAReS/DART/DART_download</a>
</P>

<TABLE border=0 cellpadding=0 width=100% summary="">
<TR><TD valign=top>Contact:       </TD><TD> nancy collins </TD></TR>
<TR><TD valign=top>Revision:      </TD><TD> $Revision$ </TD></TR>
<TR><TD valign=top>Source:        </TD><TD> $URL$ </TD></TR>
<TR><TD valign=top>Change Date:   </TD><TD> $Date$ </TD></TR>
<TR><TD valign=top>Change&nbsp;history:&nbsp;</TD><TD> try "svn&nbsp;log" or "svn&nbsp;diff" </TD></TR>
</TABLE>

<!--==================================================================-->

</BODY>
</HTML>
